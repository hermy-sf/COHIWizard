import sys
import subprocess
import re
import ipaddress
import platform

# --- Auxiliary methods for auto-detection of  the Red Pitaya IP address ---

def valid_mac(mac):
    """Check if MAC is valid and not all zeros."""
    mac = mac.lower()
    if mac in ("00:00:00:00:00:00", "00-00-00-00-00-00"):
        return False
    return bool(re.match(r"([0-9a-f]{2}[:-]){5}[0-9a-f]{2}$", mac))

def is_linklocal(ip):
    """Check if IP is in 169.254.x.y (Link-Local)."""
    try:
        return ipaddress.ip_address(ip).is_link_local
    except ValueError:
        return False

# --- Linux ohne sudo ---
def read_arp_linux(filter_oui=None):
    results = []
    try:
        with open("/proc/net/arp") as f:
            next(f)  # skip header
            for line in f:
                parts = line.split()
                ip = parts[0]
                mac = parts[3].lower()

                if not is_linklocal(ip):
                    continue
                if not valid_mac(mac):
                    continue
                if filter_oui:
                    if not any(mac.startswith(prefix.lower()) for prefix in filter_oui):
                        continue
                results.append((ip, mac))
    except FileNotFoundError:
        pass
    return results

# --- Windows ---
def read_arp_windows(filter_oui=None):
    results = []
    try:
        out = subprocess.check_output(["arp", "-a"], text=True, errors="ignore")
        # IP und MAC extrahieren (MAC kann '-' oder ':' enthalten)
        pattern = r"(\d+\.\d+\.\d+\.\d+)\s+.*?((?:[0-9a-f]{2}[:-]){5}[0-9a-f]{2})"
        matches = re.findall(pattern, out, re.IGNORECASE)
        for ip, mac in matches:
            mac = mac.lower().replace("-", ":")
            if not is_linklocal(ip):
                continue
            if not valid_mac(mac):
                continue
            if filter_oui:
                if not any(mac.startswith(prefix.lower()) for prefix in filter_oui):
                    continue
            results.append((ip, mac))
    except subprocess.SubprocessError:
        pass
    return results

# --- Cross-platform Wrapper ---
def discover_linklocal_devices(filter_oui=None):
    """
    Discover Link-Local devices (169.254.x.y) without root/admin.
    Optionally filter by MAC OUI prefixes.
    :param : filter, list of expected MAc addresses
    :pytpe : list 
    :returns : list of identified Red Pitaya IP addresses and MAC address.
    :rtype : list
    """
    system = platform.system()
    if system == "Linux":
        return read_arp_linux(filter_oui)
    elif system == "Windows":
        return read_arp_windows(filter_oui)
    else:
        # macOS: ähnlich wie Linux, arp -a funktioniert ohne sudo
        return read_arp_windows(filter_oui)
    """  Class for SDR identification and , if required, general SDR ssh connection, server start and stop,
    data stream socket control and shutdown of the SDR
    some methods emit a pyqtSignal(str) named SigMessage(messagestring) with argument messagestring 
    two settings are called via methods, i.e. set_play() and set_rec() for selecting play or rec
    :param : no regular parameters; communication occurs via
        __slots__: Dictionary with entries:
        __slots__[0]: irate, Type: int
        __slots__[1]: ifreq = LO, Type integer
        __slots__[2]: icorr Type: integer
        __slots__[3]: rates Type: list
    :raises [ErrorType]: none
    :return: none
    :rtype: none
    """

# --- Beispielaufruf ---
if __name__ == "__main__":
    # Beispiel Red Pitaya OUIs
    redpitaya_ouis = ["00:26:32", "3c:2c:30", "b8:27:eb"]

    devices = discover_linklocal_devices(filter_oui=redpitaya_ouis)

    if devices:
        print("Gefundene Red Pitayas:")
        for ip, mac in devices:
            print(f"{ip}  →  {mac}")
    else:
        print("Keine Red Pitayas gefunden.")


from zeroconf import Zeroconf, ServiceBrowser
import time

class RPListener:
    def __init__(self):
        self.devices = []

    def remove_service(self, zeroconf, type, name):
        pass

    def add_service(self, zeroconf, type, name):
        info = zeroconf.get_service_info(type, name)
        if info and name.startswith("rp-") and name.endswith(".local."):
            ip = ".".join(str(b) for b in info.addresses[0])
            self.devices.append((name.strip("."), ip))

zeroconf = Zeroconf()
listener = RPListener()
browser = ServiceBrowser(zeroconf, "_http._tcp.local.", listener)

time.sleep(2)  # kurze Wartezeit für Antworten

zeroconf.close()

print("Gefundene Red Pitayas:", listener.devices)
